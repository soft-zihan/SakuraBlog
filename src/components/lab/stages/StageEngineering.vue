<template>
  <div class="space-y-12">
    <StageLearningGuide :lang="lang" stage-id="engineering" />

    <section class="max-w-4xl mx-auto px-4">
      <div class="bg-gradient-to-r from-emerald-50 to-cyan-50 dark:from-emerald-900/20 dark:to-cyan-900/20 rounded-2xl p-5 border border-emerald-100 dark:border-emerald-800/30">
        <div class="flex items-start gap-3">
          <div class="text-2xl">ğŸ§±</div>
          <div class="flex-1">
            <div class="font-bold text-gray-800 dark:text-gray-100">
              {{ isZh ? 'å·¥ç¨‹åŒ–çš„ç›®æ ‡ï¼šå¯è¿è¡Œã€å¯æ„å»ºã€å¯éƒ¨ç½²' : 'Engineering goal: run, build, deploy' }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-300 mt-1">
              {{ isZh
                ? 'ä½ è¦èƒ½å›ç­”ï¼šå…¥å£åœ¨å“ªã€ä¾èµ–æ€ä¹ˆè£…ã€æ„å»ºåšäº†ä»€ä¹ˆã€é™æ€éƒ¨ç½²ä¸ºä»€ä¹ˆéœ€è¦ base è·¯å¾„ã€‚è¯»æ‡‚è¿™äº›ï¼Œé¡¹ç›®å°±ä¸ä¼šâ€œçœ‹èµ·æ¥å¾ˆå¤§ä½†æ‘¸ä¸ç€å¤´è„‘â€ã€‚'
                : 'You should know: where entry is, how deps install, what build does, why static deploy needs base path. Then the project becomes readable.' }}
            </div>
            <div class="flex flex-wrap gap-2 mt-3">
              <button
                type="button"
                class="text-xs px-3 py-1.5 rounded-lg bg-white/80 dark:bg-gray-900/40 border border-emerald-200 dark:border-emerald-800/40 text-emerald-700 dark:text-emerald-200 font-bold hover:opacity-90"
                @click="openLabNote('/notes/VUEå­¦ä¹ ç¬”è®°/4ã€Vue3+TS+ElementPlus.md')"
              >
                {{ isZh ? 'æ‰“å¼€ï¼šç¬”è®°4ï¼ˆå·¥ç¨‹åŒ–/TSï¼‰' : 'Open: Note 4 (Engineering/TS)' }}
              </button>
              <button
                type="button"
                class="text-xs px-3 py-1.5 rounded-lg bg-white/80 dark:bg-gray-900/40 border border-indigo-200 dark:border-indigo-800/40 text-indigo-700 dark:text-indigo-200 font-bold hover:opacity-90"
                @click="openCode('vite.config.ts', 'find:defineConfig')"
              >
                {{ isZh ? 'å¯¹ç…§ï¼švite.config.ts' : 'Compare: vite.config.ts' }}
              </button>
              <button
                type="button"
                class="text-xs px-3 py-1.5 rounded-lg bg-white/80 dark:bg-gray-900/40 border border-indigo-200 dark:border-indigo-800/40 text-indigo-700 dark:text-indigo-200 font-bold hover:opacity-90"
                @click="openCode('package.json', 'find:scripts')"
              >
                {{ isZh ? 'å¯¹ç…§ï¼špackage.jsonï¼ˆscripts/ä¾èµ–ï¼‰' : 'Compare: package.json (scripts/deps)' }}
              </button>
              <button
                type="button"
                class="text-xs px-3 py-1.5 rounded-lg bg-white/80 dark:bg-gray-900/40 border border-indigo-200 dark:border-indigo-800/40 text-indigo-700 dark:text-indigo-200 font-bold hover:opacity-90"
                @click="openCode('tsconfig.json', 'find:compilerOptions')"
              >
                {{ isZh ? 'å¯¹ç…§ï¼štsconfig.jsonï¼ˆTS ç¼–è¯‘ï¼‰' : 'Compare: tsconfig.json' }}
              </button>
              <button
                type="button"
                class="text-xs px-3 py-1.5 rounded-lg bg-white/80 dark:bg-gray-900/40 border border-indigo-200 dark:border-indigo-800/40 text-indigo-700 dark:text-indigo-200 font-bold hover:opacity-90"
                @click="openCode('src/index.html', 'find:tailwindcss')"
              >
                {{ isZh ? 'å¯¹ç…§ï¼šTailwind é…ç½®ï¼ˆCDNï¼‰' : 'Compare: Tailwind config (CDN)' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="max-w-4xl mx-auto px-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white/70 dark:bg-gray-900/30 p-5">
          <h3 class="text-sm font-extrabold text-gray-800 dark:text-gray-100 flex items-center gap-2">
            <span class="text-base">ğŸš€</span> {{ isZh ? 'ä» 0 è·‘èµ·æ¥ï¼ˆæœ€çŸ­è·¯å¾„ï¼‰' : 'Get it running (shortest path)' }}
          </h3>
          <ol class="mt-3 space-y-2 text-sm text-gray-700 dark:text-gray-300">
            <li class="flex gap-2">
              <span class="font-mono text-gray-400">1</span>
              <span>{{ isZh ? 'è£…ä¾èµ–ï¼šnpm i' : 'Install deps: npm i' }}</span>
            </li>
            <li class="flex gap-2">
              <span class="font-mono text-gray-400">2</span>
              <span>{{ isZh ? 'å¯åŠ¨å¼€å‘ï¼šnpm run dev' : 'Dev server: npm run dev' }}</span>
            </li>
            <li class="flex gap-2">
              <span class="font-mono text-gray-400">3</span>
              <span>{{ isZh ? 'çœ‹å…¥å£ï¼šsrc/main.ts â†’ App.vue' : 'Entry: src/main.ts â†’ App.vue' }}</span>
            </li>
          </ol>
          <div class="mt-4 flex flex-wrap gap-2">
            <button
              type="button"
              class="text-xs px-3 py-1.5 rounded-lg bg-white/80 dark:bg-gray-900/40 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-100 font-bold hover:opacity-90"
              @click="openCode('src/main.ts', 'find:createApp')"
            >
              {{ isZh ? 'å¯¹ç…§ï¼šsrc/main.tsï¼ˆå…¥å£ï¼‰' : 'Compare: src/main.ts (entry)' }}
            </button>
            <button
              type="button"
              class="text-xs px-3 py-1.5 rounded-lg bg-white/80 dark:bg-gray-900/40 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-100 font-bold hover:opacity-90"
              @click="openCode('src/App.vue', 'template')"
            >
              {{ isZh ? 'å¯¹ç…§ï¼šApp.vueï¼ˆæ ¹ç»„ä»¶ï¼‰' : 'Compare: App.vue (root)' }}
            </button>
          </div>
        </div>

        <div class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white/70 dark:bg-gray-900/30 p-5">
          <h3 class="text-sm font-extrabold text-gray-800 dark:text-gray-100 flex items-center gap-2">
            <span class="text-base">ğŸ“¦</span> {{ isZh ? 'æ„å»ºä¸éƒ¨ç½²ï¼ˆä½ ä¸€å®šä¼šè¸©çš„å‘ï¼‰' : 'Build & deploy (common pitfalls)' }}
          </h3>
          <ul class="mt-3 space-y-2 text-sm text-gray-700 dark:text-gray-300">
            <li class="flex gap-2">
              <span class="font-mono text-gray-400">â€¢</span>
              <span>{{ isZh ? 'é™æ€éƒ¨ç½²è¦å…³æ³¨ base è·¯å¾„ï¼ˆGitHub Pages å¸¸è§ï¼‰' : 'Static deploy needs correct base (common on GitHub Pages)' }}</span>
            </li>
            <li class="flex gap-2">
              <span class="font-mono text-gray-400">â€¢</span>
              <span>{{ isZh ? 'èµ„æºå¼•ç”¨ç”¨ç›¸å¯¹è·¯å¾„ / importï¼Œé¿å…æ„å»ºå 404' : 'Use relative/imported assets to avoid 404 after build' }}</span>
            </li>
            <li class="flex gap-2">
              <span class="font-mono text-gray-400">â€¢</span>
              <span>{{ isZh ? 'æ„å»ºäº§ç‰© dist æ˜¯â€œçº¯é™æ€æ–‡ä»¶â€ï¼Œä¸æ˜¯ Node æœåŠ¡' : 'dist is pure static files, not a Node server' }}</span>
            </li>
          </ul>
          <div class="mt-4 flex flex-wrap gap-2">
            <button
              type="button"
              class="text-xs px-3 py-1.5 rounded-lg bg-white/80 dark:bg-gray-900/40 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-100 font-bold hover:opacity-90"
              @click="openCode('vite.config.ts', 'find:base')"
            >
              {{ isZh ? 'å¯¹ç…§ï¼švite.config.tsï¼ˆbaseï¼‰' : 'Compare: vite.config.ts (base)' }}
            </button>
            <button
              type="button"
              class="text-xs px-3 py-1.5 rounded-lg bg-white/80 dark:bg-gray-900/40 border border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-100 font-bold hover:opacity-90"
              @click="openCode('package.json', 'find:scripts')"
            >
              {{ isZh ? 'å¯¹ç…§ï¼špackage.jsonï¼ˆscriptsï¼‰' : 'Compare: package.json (scripts)' }}
            </button>
          </div>
        </div>
      </div>

      <details class="mt-4 rounded-2xl border border-gray-200 dark:border-gray-700 bg-white/70 dark:bg-gray-900/30 p-5">
        <summary class="cursor-pointer font-bold text-gray-800 dark:text-gray-100">
          {{ isZh ? 'æ‰©å±•ï¼šæ’é”™ checklist' : 'Extras: debug checklist' }}
        </summary>
        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-700 dark:text-gray-300">
          <div class="rounded-xl border border-gray-100 dark:border-gray-700 bg-gray-50/60 dark:bg-gray-900/20 p-4">
            <div class="font-extrabold text-gray-800 dark:text-gray-100">{{ isZh ? 'ä¾èµ–/ç¯å¢ƒ' : 'Deps / env' }}</div>
            <ul class="mt-2 space-y-1 text-xs">
              <li>â€¢ {{ isZh ? 'Node ç‰ˆæœ¬æ˜¯å¦æ»¡è¶³ï¼ˆæŠ¥å¥‡æ€ªè¯­æ³•é”™è¯¯æ—¶å…ˆçœ‹å®ƒï¼‰' : 'Check Node version first when syntax errors look weird' }}</li>
              <li>â€¢ {{ isZh ? 'åˆ  node_modules + é‡æ–° npm i è¯•ä¸€æ¬¡' : 'Try clean install (delete node_modules, npm i)' }}</li>
              <li>â€¢ {{ isZh ? 'é”æ–‡ä»¶å†²çªï¼špackage-lock.json æ˜¯å¦ä¸€è‡´' : 'Lockfile drift: verify package-lock.json' }}</li>
            </ul>
          </div>
          <div class="rounded-xl border border-gray-100 dark:border-gray-700 bg-gray-50/60 dark:bg-gray-900/20 p-4">
            <div class="font-extrabold text-gray-800 dark:text-gray-100">{{ isZh ? 'æ„å»º/éƒ¨ç½²' : 'Build / deploy' }}</div>
            <ul class="mt-2 space-y-1 text-xs">
              <li>â€¢ {{ isZh ? 'GitHub Pagesï¼šbase å¿…é¡»åŒ¹é…ä»“åº“å/å­è·¯å¾„' : 'GitHub Pages: base must match repo/subpath' }}</li>
              <li>â€¢ {{ isZh ? 'åˆ·æ–° 404ï¼šéœ€è¦ SPA å›é€€è§„åˆ™ï¼ˆä¸æ˜¯ Vite çš„é”…ï¼‰' : 'Refresh 404: needs SPA fallback rule (not Vite issue)' }}</li>
              <li>â€¢ {{ isZh ? 'å›¾ç‰‡/å­—ä½“è·¯å¾„ï¼šæ„å»ºå dist é‡Œç¡®è®¤æ˜¯å¦å­˜åœ¨' : 'Asset paths: verify files exist in dist' }}</li>
            </ul>
          </div>
        </div>
      </details>
    </section>

    <section>
      <LabModuleSystem :lang="lang" />
    </section>

    <section>
      <div class="max-w-3xl mx-auto px-4 mb-6">
        <p class="text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border-l-4 border-red-400">
          ğŸ’¡ {{ isZh ? 'NPM æ˜¯ Node.js çš„åŒ…ç®¡ç†å™¨ã€‚' : 'NPM is Node.js package manager.' }}
        </p>
      </div>
      <LabNpm :lang="lang" />
    </section>

    <section>
      <div class="max-w-3xl mx-auto px-4 mb-6">
        <p class="text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border-l-4 border-orange-400">
          ğŸ’¡ {{ isZh ? 'Vite æ˜¯æ–°ä¸€ä»£æ„å»ºå·¥å…·ã€‚' : 'Vite is next-gen build tool.' }}
        </p>
      </div>
      <LabBuildTools :lang="lang" />
    </section>

    <section>
      <div class="max-w-3xl mx-auto px-4 mb-6">
        <p class="text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border-l-4 border-cyan-400">
          ğŸ’¡ {{ isZh ? 'Tailwind ä¸æ˜¯â€œé­”æ³•â€ï¼Œå®ƒæ˜¯ CSS çš„é«˜é¢‘ç”¨æ³•è¢«åšæˆäº†å·¥å…·ç±»ã€‚å…ˆç†è§£ CSSï¼Œå†ç”¨ Tailwind äº‹åŠåŠŸå€ã€‚' : 'Tailwind is not magicâ€”itâ€™s CSS wrapped into utilities. CSS first, Tailwind faster.' }}
        </p>
      </div>
      <LabTailwind :lang="lang" />
    </section>

    <section>
      <LabCssFrameworks :lang="lang" />
    </section>

    <NextStageGuide
      :is-zh="isZh"
      :next-text="isZh ? 'å·¥ç¨‹åŒ–åŸºç¡€æŒæ¡äº†ï¼æ¥ä¸‹æ¥è¿›å…¥ Vue æ ¸å¿ƒã€‚' : 'Engineering basics done! Next: Vue core.'"
      @next="emit('navigate', 'vue-core')"
    />
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import NextStageGuide from '../NextStageGuide.vue'
import StageLearningGuide from './StageLearningGuide.vue'
import LabModuleSystem from '../stage5-engineering/LabModuleSystem.vue'
import LabNpm from '../stage5-engineering/LabNpm.vue'
import LabBuildTools from '../stage5-engineering/LabBuildTools.vue'
import LabTailwind from '../stage5-engineering/LabTailwind.vue'
import LabCssFrameworks from '../stage5-engineering/LabCssFrameworks.vue'

const props = defineProps<{
  lang: 'en' | 'zh'
}>()

const emit = defineEmits<{
  (e: 'navigate', tab: string): void
}>()

const lang = computed(() => props.lang)
const isZh = computed(() => lang.value === 'zh')

const openLabNote = (path: string) => {
  window.dispatchEvent(new CustomEvent('sakura:open-lab-note', { detail: { path } }))
}

const openCode = (path: string, token?: string) => {
  const raw = (token || '').trim()
  const isLineRange = !!raw && /^L?\d+(-L?\d+)?$/i.test(raw)
  const isFind = raw.toLowerCase().startsWith('find:')
  const range = isLineRange ? raw : undefined
  const anchor = !isLineRange && !isFind && raw ? raw : undefined
  const find = isFind ? raw.slice('find:'.length).trim() : undefined
  window.dispatchEvent(new CustomEvent('sakura-open-code', { detail: { path, range, anchor, find } }))
}
</script>
