<template>
  <div class="space-y-12">
    <StageLearningGuide :lang="lang" stage-id="js-advanced" />

    <section class="max-w-4xl mx-auto px-4">
      <div class="bg-gradient-to-r from-sky-50 to-green-50 dark:from-sky-900/20 dark:to-green-900/20 rounded-2xl p-5 border border-sky-100 dark:border-sky-800/30">
        <div class="flex items-start gap-3">
          <div class="text-2xl">ğŸ§©</div>
          <div class="flex-1">
            <div class="font-bold text-gray-800 dark:text-gray-100">
              {{ isZh ? 'æŠŠâ€œå¼‚æ­¥ + ç±»å‹â€å˜æˆç”Ÿäº§åŠ›' : 'Turn â€œasync + typesâ€ into productivity' }}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-300 mt-1">
              {{ isZh
                ? 'è¿™ä¸€é˜¶æ®µä¸æ˜¯ä¸ºäº†ç‚«æŠ€ï¼Œè€Œæ˜¯ä¸ºäº†æŠŠå¤æ‚äº¤äº’å†™å¾—ç¨³å®šï¼šé”™è¯¯èƒ½è¢«æ•è·ã€çŠ¶æ€å¯é¢„æµ‹ã€æ•°æ®ç»“æ„æœ‰è¾¹ç•Œã€‚'
                : 'This stage focuses on stability: predictable state, proper error handling, and bounded data shapes.' }}
            </div>
            <div class="flex flex-wrap gap-2 mt-3">
              <button
                type="button"
                class="text-xs px-3 py-1.5 rounded-lg bg-white/80 dark:bg-gray-900/40 border border-sky-200 dark:border-sky-800/40 text-sky-700 dark:text-sky-200 font-bold hover:opacity-90"
                @click="openLabNote('/notes/VUEå­¦ä¹ ç¬”è®°/2ã€JavaScript.md')"
              >
                {{ isZh ? 'å›é¡¾ï¼šç¬”è®°2ï¼ˆJS å¼‚æ­¥/DOMï¼‰' : 'Review: Note 2 (Async/DOM)' }}
              </button>
              <button
                type="button"
                class="text-xs px-3 py-1.5 rounded-lg bg-white/80 dark:bg-gray-900/40 border border-sky-200 dark:border-sky-800/40 text-sky-700 dark:text-sky-200 font-bold hover:opacity-90"
                @click="openLabNote('/notes/VUEå­¦ä¹ ç¬”è®°/4ã€Vue3+TS+ElementPlus.md')"
              >
                {{ isZh ? 'ä¸»çº¿ï¼šç¬”è®°4ï¼ˆTS/å·¥ç¨‹åŒ–ï¼‰' : 'Main: Note 4 (TS/Engineering)' }}
              </button>
              <button
                type="button"
                class="text-xs px-3 py-1.5 rounded-lg bg-white/80 dark:bg-gray-900/40 border border-indigo-200 dark:border-indigo-800/40 text-indigo-700 dark:text-indigo-200 font-bold hover:opacity-90"
                @click="openCode('src/types.ts', 'find:export enum NodeType')"
              >
                {{ isZh ? 'å¯¹ç…§ï¼štypes.tsï¼ˆç±»å‹è¾¹ç•Œï¼‰' : 'Compare: types.ts (type boundary)' }}
              </button>
              <button
                type="button"
                class="text-xs px-3 py-1.5 rounded-lg bg-white/80 dark:bg-gray-900/40 border border-indigo-200 dark:border-indigo-800/40 text-indigo-700 dark:text-indigo-200 font-bold hover:opacity-90"
                @click="openCode('src/composables/useContentClick.ts', 'parseCodeLink')"
              >
                {{ isZh ? 'å¯¹ç…§ï¼šä»£ç é“¾æ¥è§£æï¼ˆå¼‚æ­¥/å¥å£®æ€§ï¼‰' : 'Compare: code link parsing (robust async)' }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section>
      <div class="max-w-3xl mx-auto px-4 mb-6">
        <p class="text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border-l-4 border-yellow-400">
          ğŸ’¡ {{ isZh ? 'å˜é‡å’Œå‡½æ•°æ˜¯ç¼–ç¨‹çš„åŸºç¡€ã€‚ç†è§£ä½œç”¨åŸŸã€é—­åŒ…ç­‰æ ¸å¿ƒæ¦‚å¿µï¼Œèƒ½å¸®åŠ©ä½ å†™å‡ºæ›´å¥å£®çš„ä»£ç ã€‚' : 'Variables and functions are programming fundamentals. Understanding scope and closures helps write more robust code.' }}
        </p>
      </div>
      <h2 class="text-xl font-bold text-yellow-600 dark:text-yellow-400 mb-4 flex items-center gap-2">
        <span class="text-2xl">âš¡</span> {{ isZh ? 'JavaScript æ ¸å¿ƒæœºåˆ¶' : 'JavaScript Core Mechanics' }}
      </h2>
      <LabJs :lang="lang" />
    </section>

    <section>
      <div class="max-w-3xl mx-auto px-4 mb-6">
        <p class="text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border-l-4 border-blue-400">
          ğŸ’¡ {{ isZh ? 'DOMï¼ˆæ–‡æ¡£å¯¹è±¡æ¨¡å‹ï¼‰æ˜¯ JS ä¸ HTML çš„æ¡¥æ¢ã€‚é€šè¿‡ DOM APIï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€ä¿®æ”¹é¡µé¢å†…å®¹ã€æ ·å¼å’Œç»“æ„ã€‚' : 'DOM bridges JS and HTML. Through DOM APIs, we can dynamically modify page content, styles, and structure.' }}
        </p>
      </div>
      <h2 class="text-xl font-bold text-blue-600 dark:text-blue-400 mb-4 flex items-center gap-2">
        <span class="text-2xl">ğŸ®</span> {{ t.lab_dom_title }}
      </h2>
      <LabDom :lang="lang" />
    </section>

    <section>
      <h2 class="text-xl font-bold text-orange-600 dark:text-orange-400 mb-4 flex items-center gap-2">
        <span class="text-2xl">ğŸ§ </span> {{ isZh ? 'é—­åŒ…ä¸ä½œç”¨åŸŸ' : 'Closures & Scope' }}
      </h2>
      <LabJsAdvanced :lang="lang" />
    </section>

    <section>
      <LabEventLoop />
    </section>

    <section class="max-w-4xl mx-auto">
      <h2 class="text-xl font-bold text-green-600 dark:text-green-400 mb-4 flex items-center gap-2 justify-center">
        <span class="text-2xl">ğŸ“¡</span> {{ t.lab_ajax_title }}
      </h2>
      <LabAjax :lang="lang" />
    </section>

    <section>
      <div class="max-w-3xl mx-auto px-4 mb-6">
        <p class="text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border-l-4 border-yellow-400">
          ğŸ’¡ {{ isZh ? 'Promise å’Œ async/await æ˜¯å¤„ç†å¼‚æ­¥æ“ä½œçš„æ ¸å¿ƒã€‚' : 'Promise and async/await are core for async operations.' }}
        </p>
      </div>
      <h2 class="text-xl font-bold text-yellow-600 dark:text-yellow-400 mb-4 flex items-center gap-2">
        <span class="text-2xl">âš¡</span> {{ isZh ? 'å¼‚æ­¥ç¼–ç¨‹' : 'Async Programming' }}
      </h2>
      <LabAsync :lang="lang" />
    </section>

    <section>
      <div class="max-w-3xl mx-auto px-4 mb-6">
        <p class="text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border-l-4 border-blue-400">
          ğŸ’¡ {{ isZh ? 'TypeScript æ˜¯ JavaScript çš„è¶…é›†ï¼Œæ·»åŠ äº†ç±»å‹ç³»ç»Ÿã€‚' : 'TypeScript is a superset of JavaScript with a type system.' }}
        </p>
      </div>
      <LabTypeScript :lang="lang" />
    </section>

    <section class="max-w-4xl mx-auto px-4">
      <details class="rounded-2xl border border-gray-200 dark:border-gray-700 bg-white/70 dark:bg-gray-900/30 p-5">
        <summary class="cursor-pointer font-bold text-gray-800 dark:text-gray-100">
          {{ isZh ? 'æ‰©å±•ï¼šTypeScript è¿›é˜¶ï¼ˆå¯é€‰ï¼‰' : 'Extras: TypeScript Advanced (optional)' }}
        </summary>
        <div class="mt-5">
          <LabTypeScriptAdvanced :lang="lang" />
        </div>
      </details>
    </section>

    <NextStageGuide
      :is-zh="isZh"
      :next-text="isZh ? 'JS è¿›é˜¶æŒæ¡äº†ï¼ä¸‹ä¸€æ­¥ï¼šå·¥ç¨‹åŒ–ã€‚' : 'JS advanced done! Next: engineering.'"
      @next="emit('navigate', 'engineering')"
    />
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue'
import { I18N } from '../../../constants'
import NextStageGuide from '../NextStageGuide.vue'
import StageLearningGuide from './StageLearningGuide.vue'
import LabJs from '../stage4-js-advanced/LabJs.vue'
import LabDom from '../stage4-js-advanced/LabDom.vue'
import LabJsAdvanced from '../stage4-js-advanced/LabJsAdvanced.vue'
import LabEventLoop from '../stage4-js-advanced/LabEventLoop.vue'
import LabAjax from '../stage4-js-advanced/LabAjax.vue'
import LabAsync from '../stage4-js-advanced/LabAsync.vue'
import LabTypeScript from '../stage4-js-advanced/LabTypeScript.vue'
import LabTypeScriptAdvanced from '../stage4-js-advanced/LabTypeScriptAdvanced.vue'

const props = defineProps<{
  lang: 'en' | 'zh'
}>()

const emit = defineEmits<{
  (e: 'navigate', tab: string): void
}>()

const lang = computed(() => props.lang)
const isZh = computed(() => lang.value === 'zh')
const t = computed(() => I18N[lang.value])

const openLabNote = (path: string) => {
  window.dispatchEvent(new CustomEvent('sakura:open-lab-note', { detail: { path } }))
}

const openCode = (path: string, token?: string) => {
  const raw = (token || '').trim()
  const isLineRange = !!raw && /^L?\d+(-L?\d+)?$/i.test(raw)
  const isFind = raw.toLowerCase().startsWith('find:')
  const range = isLineRange ? raw : undefined
  const anchor = !isLineRange && !isFind && raw ? raw : undefined
  const find = isFind ? raw.slice('find:'.length).trim() : undefined
  window.dispatchEvent(new CustomEvent('sakura-open-code', { detail: { path, range, anchor, find } }))
}
</script>
