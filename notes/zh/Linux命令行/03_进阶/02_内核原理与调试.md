# 🧠 内核原理与深度调试

> **常见真实场景**：
> “会用 top 只是开始：Load Average 到底表示什么？进程为什么会变成 Zombie？系统慢的时候，如何把‘感觉’变成可验证的排查步骤？”

本章节将带你深入 Linux 内核的冰山之下，掌握“上帝视角”的排查能力。

## 1. 进程生命周期与状态

在 `top` 或 `ps` 中，你常看到 `S`, `R`, `D`, `Z` 等状态，它们对应了进程在内核中的不同阶段。

### 1.1 五大核心状态
1.  **R (Running/Runnable)**:
    *   **含义**：正在 CPU 上执行，或者**在运行队列中等待 CPU 调度**。
    *   **误区**：Load Average 高不一定是 CPU 忙，也可能是等待 CPU 的进程太多。
2.  **S (Interruptible Sleep)**:
    *   **含义**：**浅睡眠**。进程在等待事件（如等待 socket 数据、等待用户输入）。
    *   **特点**：可以被信号唤醒（如 `kill` 能杀掉）。绝大多数后台进程大部分时间都在这个状态。
3.  **D (Uninterruptible Sleep)**:
    *   **含义**：**深睡眠**（不可中断）。通常是在**等待磁盘 I/O**。
    *   **关键点**：此时进程**不响应任何信号**（包括 `kill -9`）。如果你看到大量 D 状态进程，说明磁盘 I/O 可能是瓶颈（或挂载的 NFS 挂了）。
4.  **Z (Zombie)**:
    *   **含义**：**僵尸进程**。进程已退出，但父进程还没来得及“收尸”（读取它的退出状态）。
    *   **危害**：不占内存，但**占用 PID 资源**。如果 PID 耗尽，系统就无法创建新进程。
    *   **处理**：无法直接 kill 僵尸（因为它已经死了），需要 kill 它的**父进程**，让 init 进程接管并回收。
5.  **T (Stopped)**:
    *   **含义**：进程被暂停（如收到 `SIGSTOP` 或 `Ctrl+Z`）。

---

## 2. 内存管理迷思

Linux 的内存管理策略是：**“闲置的内存是浪费”**。

### 2.1 内存去哪了？(Page Cache)
你运行 `free -h` 发现 `buff/cache` 占用很高，可用内存很少。
*   **真相**：Linux 会把读取过的文件缓存在内存中（Page Cache），下次读取直接走内存，速度快 N 倍。
*   **不用慌**：应用程序需要内存时，内核会瞬间释放 Cache 给应用用。

### 2.2 OOM Killer (内存溢出杀手)
当物理内存 + Swap 都耗尽时，内核会触发 **OOM Killer**。
*   **机制**：内核会对所有进程打分 (`oom_score`)，分数最高的（通常是占用内存最多且非核心的）会被直接杀掉以保全系统。
*   **排查**：查看日志 `dmesg | grep -i "out of memory"`。

### 2.3 Swap (交换空间)
*   **作用**：当物理内存不足时，把不活跃的内存数据搬到磁盘上。
*   **性能**：磁盘速度远慢于内存，如果系统频繁使用 Swap（Swap In/Out 很高），系统会巨卡。

---

## 3. 文件系统底层：Inode

### 3.1 什么是 Inode？
文件系统由两部分组成：
1.  **Block**：存文件的**实际内容**。
2.  **Inode**：存文件的**元数据**（权限、拥有者、时间、Block 的位置等）。

**面试题：为什么 `rm` 删除大文件很快？**
因为 `rm` 只是解除了文件名和 Inode 的链接，并标记 Inode 可用，并没有真正擦除 Block 里的数据（除非有其他硬链接）。

### 3.2 硬链接 vs 软链接
*   **硬链接 (Hard Link)**: `ln source target`
    *   **原理**：两个文件名指向**同一个 Inode**。
    *   **特点**：删除原文件，目标文件**依然可用**。不能跨分区，不能链接目录。
*   **软链接 (Symbolic Link)**: `ln -s source target` (类似 Windows 快捷方式)
    *   **原理**：创建一个新文件（有新 Inode），内容是原文件的**路径**。
    *   **特点**：删除原文件，软链接**失效**。可以跨分区，可以链接目录。

---

## 4. 深度调试工具箱

### 4.1 strace：透视进程的“读心术”
当程序卡住、报错但没有日志时，`strace` 是神器。它能记录进程调用的所有**系统调用**。

*   **追踪进程**：`strace -p <PID>`
*   **统计耗时**：`strace -c -p <PID>` (查看进程把时间花在哪个系统调用上)
*   **实战场景**：
    *   **Web服务起不来**：`strace -e open nginx` -> 发现它在尝试读取一个不存在的配置文件路径。
    *   **程序卡死**：`strace -p PID` -> 发现一直停留在 `connect`，说明网络连不上。

### 4.2 vmstat：系统健康心电图
比 `top` 更客观的全局分析。
`vmstat 1` (每秒刷新一次)

```text
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 2  0      0 120000  40000 500000    0    0    10    20  100  200 10  5 85  0  0
```
*   **r (run)**: 运行队列长度。如果 `r > CPU核心数`，说明 CPU 负载重。
*   **b (block)**: 等待 I/O 的进程数（即 D 状态）。如果不为 0，说明磁盘可能是瓶颈。
*   **si/so**: Swap In/Out。**如果不为 0，说明内存严重不足**，系统正在颠簸。
*   **wa (wait)**: CPU 等待 I/O 的时间百分比。如果很高，确认磁盘瓶颈。

### 4.3 iostat：磁盘性能分析
`iostat -x -k 1`

*   **%util**: 磁盘利用率。如果接近 100%，说明磁盘已经饱和（满负荷运转），请求在排队。
*   **await**: 平均 I/O 响应时间。如果这个值很大（如 > 100ms），说明磁盘响应慢。
